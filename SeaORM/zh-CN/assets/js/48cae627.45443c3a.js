"use strict";(self.webpackChunksea_orm=self.webpackChunksea_orm||[]).push([[43951],{28453:(n,e,i)=>{i.d(e,{R:()=>o,x:()=>r});var a=i(96540);const t={},l=a.createContext(t);function o(n){const e=a.useContext(l);return a.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function r(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(t):n.components||t:o(n.components),a.createElement(l.Provider,{value:e},n.children)}},64647:(n,e,i)=>{i.r(e),i.d(e,{assets:()=>c,contentTitle:()=>r,default:()=>u,frontMatter:()=>o,metadata:()=>a,toc:()=>d});const a=JSON.parse('{"id":"advanced-query/custom-join-condition","title":"\u81ea\u5b9a\u4e49\u8fde\u63a5\u6761\u4ef6","description":"\u6709\u65f6\u4f60\u53ef\u80fd\u5e0c\u671b\u4f7f\u7528\u81ea\u5b9a\u4e49\u6761\u4ef6 join \u53e6\u4e00\u4e2a\u8868\uff0c\u4f8b\u5982\uff1a","source":"@site/i18n/zh-CN/docusaurus-plugin-content-docs/current/08-advanced-query/04-custom-join-condition.md","sourceDirName":"08-advanced-query","slug":"/advanced-query/custom-join-condition","permalink":"/SeaORM/zh-CN/docs/advanced-query/custom-join-condition","draft":false,"unlisted":false,"editUrl":"https://github.com/SeaQL/seaql.github.io/edit/master/SeaORM/docs/08-advanced-query/04-custom-join-condition.md","tags":[],"version":"current","lastUpdatedBy":"Chris Tsang","lastUpdatedAt":1772389428000,"sidebarPosition":4,"frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"\u805a\u5408\u51fd\u6570","permalink":"/SeaORM/zh-CN/docs/advanced-query/aggregate-function"},"next":{"title":"\u5b50\u67e5\u8be2","permalink":"/SeaORM/zh-CN/docs/advanced-query/subquery"}}');var t=i(74848),l=i(28453);const o={},r="\u81ea\u5b9a\u4e49\u8fde\u63a5\u6761\u4ef6",c={},d=[{value:"\u5173\u8054",id:"\u5173\u8054",level:2},{value:"\u94fe\u63a5\u5173\u8054",id:"\u94fe\u63a5\u5173\u8054",level:2},{value:"\u4e34\u65f6\u5b9a\u4e49",id:"\u4e34\u65f6\u5b9a\u4e49",level:2},{value:"<code>OR</code> \u6761\u4ef6",id:"or-\u6761\u4ef6",level:2}];function s(n){const e={code:"code",h1:"h1",h2:"h2",header:"header",p:"p",pre:"pre",...(0,l.R)(),...n.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(e.header,{children:(0,t.jsx)(e.h1,{id:"\u81ea\u5b9a\u4e49\u8fde\u63a5\u6761\u4ef6",children:"\u81ea\u5b9a\u4e49\u8fde\u63a5\u6761\u4ef6"})}),"\n",(0,t.jsx)(e.p,{children:"\u6709\u65f6\u4f60\u53ef\u80fd\u5e0c\u671b\u4f7f\u7528\u81ea\u5b9a\u4e49\u6761\u4ef6 join \u53e6\u4e00\u4e2a\u8868\uff0c\u4f8b\u5982\uff1a"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-sql",children:"SELECT\n    `cake`.`id`,\n    `cake`.`name`\nFROM\n    `cake`\n    LEFT JOIN `fruit` ON `cake`.`id` = `fruit`.`cake_id`\n    AND `fruit`.`name` LIKE '%tropical%' -- Custom Join Condition\n"})}),"\n",(0,t.jsx)(e.p,{children:"\u53ef\u4ee5\u901a\u8fc7\u591a\u79cd\u65b9\u5f0f\u5b9e\u73b0\u3002"}),"\n",(0,t.jsx)(e.h2,{id:"\u5173\u8054",children:"\u5173\u8054"}),"\n",(0,t.jsxs)(e.p,{children:["\u5c06\u989d\u5916\u7684 join \u6761\u4ef6\u76f4\u63a5\u6dfb\u52a0\u5230 relation \u679a\u4e3e\u3002\u6700\u7b80\u5355\u7684\u65b9\u5f0f\u662f\u901a\u8fc7 ",(0,t.jsx)(e.code,{children:"on_condition"})," \u8fc7\u7a0b\u5b8f\u5c5e\u6027\u63d0\u4f9b ",(0,t.jsx)(e.code,{children:"sea_query::SimpleExpr"}),"\u3002"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-rust",children:'#[derive(Copy, Clone, Debug, EnumIter, DeriveRelation)]\npub enum Relation {\n    #[sea_orm(has_many = "super::fruit::Entity")]\n    Fruit,\n    #[sea_orm(\n        has_many = "super::fruit::Entity",\n        // Additional on_condition, accept anything that implements `sea_query::IntoCondition`\n        on_condition = r#"super::fruit::Column::Name.like("%tropical%")"#\n    )]\n    TropicalFruit,\n}\n'})}),"\n",(0,t.jsx)(e.p,{children:"\u4e0a\u8ff0\u8fc7\u7a0b\u5b8f\u5c06\u5c55\u5f00\u4e3a\uff1a"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-rust",children:'#[derive(Copy, Clone, Debug, EnumIter)]\npub enum Relation {\n    Fruit,\n    TropicalFruit,\n}\n\nimpl RelationTrait for Relation {\n    fn def(&self) -> RelationDef {\n        match self {\n            Self::Fruit => Entity::has_many(super::fruit::Entity).into(),\n            Self::TropicalFruit => Entity::has_many(super::fruit::Entity)\n                .on_condition(|_left, _right| {\n                    super::fruit::Column::Name.like("%tropical%")\n                        .into_condition()\n                })\n                .into(),\n        }\n    }\n}\n'})}),"\n",(0,t.jsx)(e.p,{children:"\u751f\u6210\u7684 SQL \u5c06\u662f\uff1a"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-rust",children:'assert_eq!(\n    cake::Entity::find()\n        .join(JoinType::LeftJoin, cake::Relation::TropicalFruit.def())\n        .build(DbBackend::MySql)\n        .to_string(),\n    [\n        "SELECT `cake`.`id`, `cake`.`name` FROM `cake`",\n        "LEFT JOIN `fruit` ON `cake`.`id` = `fruit`.`cake_id` AND `fruit`.`name` LIKE \'%tropical%\'",\n    ]\n    .join(" ")\n);\n'})}),"\n",(0,t.jsx)(e.h2,{id:"\u94fe\u63a5\u5173\u8054",children:"\u94fe\u63a5\u5173\u8054"}),"\n",(0,t.jsxs)(e.p,{children:["\u4f60\u4e5f\u53ef\u4ee5\u5728 ",(0,t.jsx)(e.code,{children:"Linked"})," \u4e0a\u5b9a\u4e49\u81ea\u5b9a\u4e49 join \u6761\u4ef6\u3002"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-rust",children:'#[derive(Debug)]\npub struct CheeseCakeToFillingVendor;\n\nimpl Linked for CheeseCakeToFillingVendor {\n    type FromEntity = super::cake::Entity;\n\n    type ToEntity = super::vendor::Entity;\n\n    fn link(&self) -> Vec<RelationDef> {\n        vec![\n            super::cake_filling::Relation::Cake\n                .def()\n                // The `on_condition` method takes a closure with parameters\n                // denoting the left-hand side and right-hand side table in the join expression.\n                .on_condition(|left, _right| {\n                    Expr::col((left, super::cake::Column::Name))\n                        .like("%cheese%")\n                        .into_condition()\n                })\n                .rev(),\n            super::cake_filling::Relation::Filling.def(),\n            super::filling::Relation::Vendor.def(),\n        ]\n    }\n}\n'})}),"\n",(0,t.jsx)(e.p,{children:"\u751f\u6210\u7684 SQL \u5c06\u662f\uff1a"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-rust",children:'assert_eq!(\n    cake::Entity::find()\n        .find_also_linked(entity_linked::CheeseCakeToFillingVendor)\n        .build(DbBackend::MySql)\n        .to_string(),\n    [\n        r#"SELECT `cake`.`id` AS `A_id`, `cake`.`name` AS `A_name","#,\n        r#"`r2`.`id` AS `B_id`, `r2`.`name` AS `B_name`"#,\n        r#"FROM `cake`"#,\n        r#"LEFT JOIN `cake_filling` AS `r0` ON `cake`.`id` = `r0`.`cake_id` AND `cake`.`name` LIKE \'%cheese%\'"#,\n        r#"LEFT JOIN `filling` AS `r1` ON `r0`.`filling_id` = `r1`.`id`"#,\n        r#"LEFT JOIN `vendor` AS `r2` ON `r1`.`vendor_id` = `r2`.`id`"#,\n    ]\n    .join(" ")\n);\n'})}),"\n",(0,t.jsx)(e.h2,{id:"\u4e34\u65f6\u5b9a\u4e49",children:"\u4e34\u65f6\u5b9a\u4e49"}),"\n",(0,t.jsx)(e.p,{children:"\u6700\u540e\uff0c\u81ea\u5b9a\u4e49 join \u6761\u4ef6\u53ef\u4ee5\u5728\u4f60\u6784\u5efa join \u8868\u8fbe\u5f0f\u65f6\u5b9a\u4e49\u3002"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-rust",children:'assert_eq!(\n    cake::Entity::find()\n        .join(JoinType::LeftJoin, cake::Relation::TropicalFruit.def())\n        .join(\n            JoinType::LeftJoin,\n            cake_filling::Relation::Cake\n                .def()\n                .rev()\n                .on_condition(|_left, right| {\n                    Expr::col((right, cake_filling::Column::CakeId))\n                        .gt(10)\n                        .into_condition()\n                })\n        )\n        .join(\n            JoinType::LeftJoin,\n            cake_filling::Relation::Filling\n                .def()\n                .on_condition(|_left, right| {\n                    Expr::col((right, filling::Column::Name))\n                        .like("%lemon%")\n                        .into_condition()\n                })\n        )\n        .join(JoinType::LeftJoin, filling::Relation::Vendor.def())\n        .build(DbBackend::MySql)\n        .to_string(),\n    [\n        "SELECT `cake`.`id`, `cake`.`name` FROM `cake`",\n        "LEFT JOIN `fruit` ON `cake`.`id` = `fruit`.`cake_id` AND `fruit`.`name` LIKE \'%tropical%\'",\n        "LEFT JOIN `cake_filling` ON `cake`.`id` = `cake_filling`.`cake_id` AND `cake_filling`.`cake_id` > 10",\n        "LEFT JOIN `filling` ON `cake_filling`.`filling_id` = `filling`.`id` AND `filling`.`name` LIKE \'%lemon%\'",\n        "LEFT JOIN `vendor` ON `filling`.`vendor_id` = `vendor`.`id`",\n    ]\n    .join(" ")\n);\n'})}),"\n",(0,t.jsx)(e.p,{children:"\u4f60\u53ef\u4ee5\u5728 join \u8bed\u53e5\u4e2d\u6307\u5b9a\u8868\u522b\u540d\uff1a"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-rust",children:'let cf = "cf";\n\nassert_eq!(\n    cake::Entity::find()\n        .join_as(\n            JoinType::LeftJoin,\n            cake_filling::Relation::Cake.def().rev(),\n            cf.clone()\n        )\n        .join(\n            JoinType::LeftJoin,\n            cake_filling::Relation::Filling.def().from_alias(cf)\n        )\n        .build(DbBackend::MySql)\n        .to_string(),\n    [\n        "SELECT `cake`.`id`, `cake`.`name` FROM `cake`",\n        "LEFT JOIN `cake_filling` AS `cf` ON `cake`.`id` = `cf`.`cake_id`",\n        "LEFT JOIN `filling` ON `cf`.`filling_id` = `filling`.`id`",\n    ]\n    .join(" ")\n);\n'})}),"\n",(0,t.jsxs)(e.h2,{id:"or-\u6761\u4ef6",children:[(0,t.jsx)(e.code,{children:"OR"})," \u6761\u4ef6"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-rust",metastring:"{6}",children:'#[derive(Copy, Clone, Debug, EnumIter, DeriveRelation)]\npub enum Relation {\n    #[sea_orm(\n        has_many = "super::fruit::Entity",\n        on_condition = r#"super::fruit::Column::Name.like("%tropical%")"#\n        condition_type = "any",\n    )]\n    OrTropicalFruit,\n}\n'})}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-rust",metastring:"{7,12}",children:'assert_eq!(\n    cake::Entity::find()\n        .column_as(\n            Expr::col(("cake_filling_alias", cake_filling::Column::CakeId)),\n            "cake_filling_cake_id"\n        )\n        .join(JoinType::LeftJoin, cake::Relation::OrTropicalFruit.def())\n        .join_as_rev(\n            JoinType::LeftJoin,\n            cake_filling::Relation::Cake\n                .def()\n                .condition_type(ConditionType::Any)\n                .on_condition(|left, _right| {\n                    Expr::col((left, cake_filling::Column::CakeId))\n                        .gt(10)\n                        .into_condition()\n                }),\n            "cake_filling_alias"\n        )\n        .build(DbBackend::MySql)\n        .to_string(),\n    [\n        "SELECT `cake`.`id`, `cake`.`name`, `cake_filling_alias`.`cake_id` AS `cake_filling_cake_id` FROM `cake`",\n        "LEFT JOIN `fruit` ON `cake`.`id` = `fruit`.`cake_id` OR `fruit`.`name` LIKE \'%tropical%\'",\n        "LEFT JOIN `cake_filling` AS `cake_filling_alias` ON `cake_filling_alias`.`cake_id` = `cake`.`id` OR `cake_filling_alias`.`cake_id` > 10",\n    ]\n    .join(" ")\n);\n'})})]})}function u(n={}){const{wrapper:e}={...(0,l.R)(),...n.components};return e?(0,t.jsx)(e,{...n,children:(0,t.jsx)(s,{...n})}):s(n)}}}]);