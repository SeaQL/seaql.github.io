"use strict";(self.webpackChunksea_orm=self.webpackChunksea_orm||[]).push([[72686],{4198:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>d,contentTitle:()=>i,default:()=>h,frontMatter:()=>a,metadata:()=>c,toc:()=>t});const c=JSON.parse('{"id":"data-science/clickhouse","title":"ClickHouse","description":"sea-clickhouse \u662f\u4e00\u6b3e\u4e0e SeaQL \u751f\u6001\u96c6\u6210\u7684 ClickHouse \u5ba2\u6237\u7aef\u3002\u5b83\u662f clickhouse-rs \u7684\u8f6f\u5206\u652f\uff0c100% \u517c\u5bb9\u4e0a\u6e38\u6240\u6709\u7279\u6027\uff0c\u5e76\u6301\u7eed\u57fa\u4e8e\u4e0a\u6e38 rebase\u3002","source":"@site/i18n/zh-CN/docusaurus-plugin-content-docs/current/12-data-science/02-clickhouse.md","sourceDirName":"12-data-science","slug":"/data-science/clickhouse","permalink":"/SeaORM/zh-CN/docs/data-science/clickhouse","draft":false,"unlisted":false,"editUrl":"https://github.com/SeaQL/seaql.github.io/edit/master/SeaORM/docs/12-data-science/02-clickhouse.md","tags":[],"version":"current","lastUpdatedBy":"Chris Tsang","lastUpdatedAt":1772368507000,"sidebarPosition":2,"frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Arrow & Parquet","permalink":"/SeaORM/zh-CN/docs/data-science/arrow-parquet"},"next":{"title":"\u7279\u5f81\u4e0e\u7c7b\u578b","permalink":"/SeaORM/zh-CN/docs/internal-design/trait-and-type"}}');var s=r(74848),l=r(28453);const a={},i="ClickHouse",d={},t=[{value:"\u5b89\u88c5",id:"\u5b89\u88c5",level:2},{value:"\u52a8\u6001 DataRow",id:"\u52a8\u6001-datarow",level:2},{value:"\u63d2\u5165 DataRow",id:"\u63d2\u5165-datarow",level:2},{value:"\u5217\u5f0f\u6279\u91cf\u64cd\u4f5c",id:"\u5217\u5f0f\u6279\u91cf\u64cd\u4f5c",level:2},{value:"Apache Arrow",id:"apache-arrow",level:2},{value:"SeaORM \u5230 ClickHouse",id:"seaorm-\u5230-clickhouse",level:3},{value:"Arrow Schema \u5230 ClickHouse \u8868",id:"arrow-schema-\u5230-clickhouse-\u8868",level:3},{value:"\u7c7b\u578b\u6620\u5c04",id:"\u7c7b\u578b\u6620\u5c04",level:2},{value:"\u5b8c\u6574\u793a\u4f8b",id:"\u5b8c\u6574\u793a\u4f8b",level:2}];function o(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,l.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"clickhouse",children:"ClickHouse"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.a,{href:"https://docs.rs/sea-clickhouse",children:(0,s.jsx)(n.code,{children:"sea-clickhouse"})})," \u662f\u4e00\u6b3e\u4e0e SeaQL \u751f\u6001\u96c6\u6210\u7684 ClickHouse \u5ba2\u6237\u7aef\u3002\u5b83\u662f ",(0,s.jsx)(n.a,{href:"https://github.com/ClickHouse/clickhouse-rs",children:(0,s.jsx)(n.code,{children:"clickhouse-rs"})})," \u7684\u8f6f\u5206\u652f\uff0c100% \u517c\u5bb9\u4e0a\u6e38\u6240\u6709\u7279\u6027\uff0c\u5e76\u6301\u7eed\u57fa\u4e8e\u4e0a\u6e38 rebase\u3002"]}),"\n",(0,s.jsxs)(n.p,{children:["\u67e5\u8be2\u7ed3\u679c\u4f1a\u89e3\u7801\u4e3a ",(0,s.jsx)(n.code,{children:"sea_query::Value"}),"\uff0c\u8ba9\u4f60\u65e0\u9700\u5b9a\u4e49\u4efb\u4f55 Schema \u7ed3\u6784\u4f53\u5373\u53ef\u83b7\u5f97\u5bf9 ",(0,s.jsx)(n.code,{children:"DateTime"}),"\u3001",(0,s.jsx)(n.code,{children:"Decimal"}),"\u3001",(0,s.jsx)(n.code,{children:"BigDecimal"}),"\u3001",(0,s.jsx)(n.code,{children:"Json"}),"\u3001\u6570\u7ec4\u7b49\u7684\u539f\u751f\u652f\u6301\u3002\u540c\u65f6\u652f\u6301 Apache Arrow\uff1a\u53ef\u5c06\u67e5\u8be2\u7ed3\u679c\u76f4\u63a5\u6d41\u5f0f\u8f93\u51fa\u4e3a ",(0,s.jsx)(n.code,{children:"RecordBatch"}),"\uff0c\u6216\u5c06 Arrow \u6279\u6b21\u63d2\u5165\u56de ClickHouse\u3002"]}),"\n",(0,s.jsx)(n.h2,{id:"\u5b89\u88c5",children:"\u5b89\u88c5"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-toml",children:'[dependencies]\n# Dynamic DataRow + SeaQuery value support\nsea-clickhouse = { version = "0.14", features = ["sea-ql"] }\n\n# Apache Arrow support (includes sea-ql)\nsea-clickhouse = { version = "0.14", features = ["arrow"] }\n'})}),"\n",(0,s.jsx)(n.h2,{id:"\u52a8\u6001-datarow",children:"\u52a8\u6001 DataRow"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"fetch_rows()"})," \u4f1a\u5c06\u6bcf\u5217\u89e3\u7801\u4e3a\u5bf9\u5e94\u7684 ",(0,s.jsx)(n.code,{children:"sea_query::Value"})," \u53d8\u4f53\uff0c\u65e0\u9700 Schema \u7ed3\u6784\u4f53\uff1a"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-rust",children:"use clickhouse::{Client, DataRow, error::Result};\nuse sea_query::Value;\n\nlet mut cursor = client\n    .query(\n        \"SELECT\n            1::UInt8                              AS u8_col,\n            3.14::Float64                         AS f64_col,\n            'hello'::String                       AS str_col,\n            toDate('2026-01-15')                  AS date_col,\n            toDateTime('2026-01-15 12:34:56')     AS dt_col,\n            toDecimal64(123.45, 2)                AS dec64_col,\n            NULL::Nullable(Int32)                 AS null_col,\n            ['a', 'b', 'c']::Array(String)        AS arr_col\n        \",\n    )\n    .fetch_rows()?;\n\nlet row = cursor.next().await?.unwrap();\nassert_eq!(row.values[0], Value::TinyUnsigned(Some(1)));\nassert_eq!(row.values[2], Value::String(Some(\"hello\".into())));\nassert_eq!(row.values[7], Value::Json(Some(Box::new(serde_json::json!([\"a\", \"b\", \"c\"])))));\n"})}),"\n",(0,s.jsx)(n.p,{children:"\u503c\u53ef\u5728\u8fd0\u884c\u65f6\u8f6c\u6362\u4e3a\u6240\u9700\u7c7b\u578b\uff1a"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-rust",children:'let row = cursor.next().await?.expect("expected one row");\n\nassert_eq!(row.try_get::<f64, _>(0)?, 2.0);          // by index\nassert_eq!(row.try_get::<Decimal, _>("value")?, 2.into()); // by column name\n'})}),"\n",(0,s.jsx)(n.h2,{id:"\u63d2\u5165-datarow",children:"\u63d2\u5165 DataRow"}),"\n",(0,s.jsxs)(n.p,{children:["\u4f7f\u7528\u5171\u4eab\u5217\u5217\u8868\u6784\u5efa ",(0,s.jsx)(n.code,{children:"DataRow"}),"\uff0c\u5e76\u5728\u5355\u6b21\u6d41\u5f0f\u8bf7\u6c42\u4e2d\u63d2\u5165\uff1a"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-rust",children:'use std::sync::Arc;\nuse clickhouse::{Client, DataRow};\nuse sea_query::Value;\n\nlet columns: Arc<[Arc<str>]> = Arc::from(["id".into(), "name".into(), "score".into()]);\n\nlet rows: Vec<DataRow> = (0u32..5)\n    .map(|i| DataRow {\n        columns: columns.clone(),\n        values: vec![\n            Value::Unsigned(Some(i)),\n            Value::String(Some("original".into())),\n            Value::Double(Some(i as f64 * 1.5)),\n        ],\n    })\n    .collect();\n\nlet mut insert = client.insert_data_row("my_table", &rows[0]).await?;\nfor row in &rows {\n    insert.write_row(row).await?;\n}\ninsert.end().await?;\n'})}),"\n",(0,s.jsx)(n.h2,{id:"\u5217\u5f0f\u6279\u91cf\u64cd\u4f5c",children:"\u5217\u5f0f\u6279\u91cf\u64cd\u4f5c"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"next_batch(max_rows)"})," \u6309\u5217\u7d2f\u79ef\u884c\u5230 ",(0,s.jsx)(n.code,{children:"RowBatch"}),"\uff08\u6bcf\u5217\u4e00\u4e2a ",(0,s.jsx)(n.code,{children:"Vec<Value>"}),"\uff09\uff0c\u4f7f\u5176\u6210\u4e3a\u901a\u5f80 Apache Arrow \u7684\u81ea\u7136\u6865\u6881\uff1a"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-rust",children:'let mut cursor = client\n    .query("SELECT number::UInt64 AS n, number * 2 AS doubled FROM system.numbers LIMIT 1000")\n    .fetch_rows()?;\n\nwhile let Some(batch) = cursor.next_batch(256).await? {\n    // batch.column_names[i]  - column name\n    // batch.column_data[i]   - Vec<Value> for column i\n    // batch.num_rows\n}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"apache-arrow",children:"Apache Arrow"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"next_arrow_batch(chunk_size)"})," \u5c06 ClickHouse \u7ed3\u679c\u4ee5 ",(0,s.jsx)(n.code,{children:"arrow::RecordBatch"})," \u5f62\u5f0f\u6d41\u5f0f\u8f93\u51fa\uff0c\u53ef\u76f4\u63a5\u7528\u4e8e DataFusion\u3001Polars\u3001Parquet \u5bfc\u51fa\u6216\u4efb\u610f Arrow \u6d88\u8d39\u8005\uff1a"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-rust",children:'let mut cursor = client.query("SELECT * FROM sensor_data").fetch_rows()?;\n\nwhile let Some(batch) = cursor.next_arrow_batch(1000).await? {\n    arrow::util::pretty::print_batches(&[batch]).unwrap();\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"seaorm-\u5230-clickhouse",children:"SeaORM \u5230 ClickHouse"}),"\n",(0,s.jsxs)(n.p,{children:["\u4ece SeaORM \u5b9e\u4f53\u6784\u5efa Arrow ",(0,s.jsx)(n.code,{children:"RecordBatch"}),"\uff0c\u5e76\u76f4\u63a5\u63d2\u5165 ClickHouse\uff1a"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-rust",children:'use sea_orm::{ArrowSchema, Set};\n\n#[sea_orm::model]\n#[derive(Clone, Debug, PartialEq, DeriveEntityModel)]\n#[sea_orm(table_name = "measurement", arrow_schema)]\npub struct Model {\n    #[sea_orm(primary_key)]\n    pub id: i32,\n    pub recorded_at: ChronoDateTime,\n    pub sensor_id: i32,\n    pub temperature: f64,\n    #[sea_orm(column_type = "Decimal(Some((38, 4)))")]\n    pub voltage: Decimal,\n}\n\nlet models: Vec<measurement::ActiveModel> = vec![..];\nlet schema = measurement::Entity::arrow_schema();\nlet batch = measurement::ActiveModel::to_arrow(&models, &schema)?;\n\nlet mut insert = client.insert_arrow("measurement", &batch).await?;\ninsert.write_batch(&batch).await?;\ninsert.end().await?;\n'})}),"\n",(0,s.jsx)(n.h3,{id:"arrow-schema-\u5230-clickhouse-\u8868",children:"Arrow Schema \u5230 ClickHouse \u8868"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"ClickHouseSchema::from_arrow"})," \u53ef\u4ece Arrow Schema \u6d3e\u751f\u5b8c\u6574\u7684 ",(0,s.jsx)(n.code,{children:"CREATE TABLE"})," DDL\uff1a"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-rust",children:'use clickhouse::schema::{ClickHouseSchema, Engine};\n\nlet mut schema = ClickHouseSchema::from_arrow(&batch.schema());\nschema\n    .table_name("measurement")\n    .engine(Engine::ReplacingMergeTree)\n    .primary_key(["recorded_at", "sensor_id"]);\nschema.find_column_mut("sensor_id").set_low_cardinality(true);\n\nlet ddl = schema.to_string();\nclient.query(&ddl).execute().await?;\n'})}),"\n",(0,s.jsx)(n.p,{children:"\u751f\u6210\u7684 DDL\uff1a"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"CREATE TABLE measurement (\n    id Int32,\n    recorded_at DateTime64(6),\n    sensor_id Int32,\n    temperature Float64,\n    voltage Decimal(38, 4)\n) ENGINE = ReplacingMergeTree()\nPRIMARY KEY (recorded_at, sensor_id)\n"})}),"\n",(0,s.jsx)(n.h2,{id:"\u7c7b\u578b\u6620\u5c04",children:"\u7c7b\u578b\u6620\u5c04"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"ClickHouse Type"}),(0,s.jsxs)(n.th,{children:[(0,s.jsx)(n.code,{children:"sea_query::Value"})," Variant"]})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"Bool"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"Value::Bool"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.code,{children:"Int8"}),"\u2013",(0,s.jsx)(n.code,{children:"Int64"})]}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.code,{children:"Value::TinyInt"}),"\u2013",(0,s.jsx)(n.code,{children:"Value::BigInt"})]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.code,{children:"UInt8"}),"\u2013",(0,s.jsx)(n.code,{children:"UInt64"})]}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.code,{children:"Value::TinyUnsigned"}),"\u2013",(0,s.jsx)(n.code,{children:"Value::BigUnsigned"})]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.code,{children:"Int128"})," / ",(0,s.jsx)(n.code,{children:"Int256"})," / ",(0,s.jsx)(n.code,{children:"UInt128"})," / ",(0,s.jsx)(n.code,{children:"UInt256"})]}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.code,{children:"Value::BigDecimal"})," (scale 0)"]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.code,{children:"Float32"})," / ",(0,s.jsx)(n.code,{children:"Float64"})]}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.code,{children:"Value::Float"})," / ",(0,s.jsx)(n.code,{children:"Value::Double"})]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"String"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"Value::String"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"FixedString(n)"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"Value::Bytes"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"UUID"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"Value::Uuid"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.code,{children:"Date"})," / ",(0,s.jsx)(n.code,{children:"Date32"})]}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"Value::ChronoDate"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.code,{children:"DateTime"})," / ",(0,s.jsx)(n.code,{children:"DateTime64"})]}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"Value::ChronoDateTime"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.code,{children:"Decimal32"})," / ",(0,s.jsx)(n.code,{children:"Decimal64"})]}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"Value::Decimal"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"Decimal128"})}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.code,{children:"Value::Decimal"})," \u6216 scale > 28 \u65f6\u4e3a ",(0,s.jsx)(n.code,{children:"Value::BigDecimal"})]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"Decimal256"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"Value::BigDecimal"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.code,{children:"Array(T)"})," / ",(0,s.jsx)(n.code,{children:"Tuple(...)"})," / ",(0,s.jsx)(n.code,{children:"Map(K,V)"})]}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"Value::Json"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.code,{children:"Nullable(T)"})," null"]}),(0,s.jsxs)(n.td,{children:["\u5bf9\u5e94\u7c7b\u578b\u7684 ",(0,s.jsx)(n.code,{children:"None"})," \u53d8\u4f53"]})]})]})]}),"\n",(0,s.jsx)(n.h2,{id:"\u5b8c\u6574\u793a\u4f8b",children:"\u5b8c\u6574\u793a\u4f8b"}),"\n",(0,s.jsxs)(n.p,{children:["\u53ef\u8fd0\u884c\u793a\u4f8b\u53ef\u5728 ",(0,s.jsx)(n.a,{href:"https://github.com/SeaQL/clickhouse-rs",children:"sea-clickhouse \u4ed3\u5e93"})," \u4e2d\u67e5\u770b\uff1a"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"https://github.com/SeaQL/clickhouse-rs/blob/main/examples/data_rows.rs",children:(0,s.jsx)(n.code,{children:"data_rows"})})," \u2014 \u83b7\u53d6\u884c\u5e76\u65ad\u8a00\u7c7b\u578b\u6620\u5c04"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"https://github.com/SeaQL/clickhouse-rs/blob/main/examples/data_row_insert.rs",children:(0,s.jsx)(n.code,{children:"data_row_insert"})})," \u2014 \u63d2\u5165\u3001\u4fee\u6539\u3001\u91cd\u65b0\u63d2\u5165\uff08ReplacingMergeTree\uff09"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"https://github.com/SeaQL/clickhouse-rs/blob/main/examples/arrow_sensor_data.rs",children:(0,s.jsx)(n.code,{children:"arrow_sensor_data"})})," \u2014 \u901a\u8fc7 Arrow \u5904\u7406\u4f20\u611f\u5668\u6570\u636e"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"https://github.com/SeaQL/clickhouse-rs/blob/main/sea-orm-arrow-example/src/main.rs",children:(0,s.jsx)(n.code,{children:"sea-orm-arrow-example"})})," \u2014 SeaORM \u5b9e\u4f53\u5230 Arrow \u5230 ClickHouse"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(o,{...e})}):o(e)}},28453:(e,n,r)=>{r.d(n,{R:()=>a,x:()=>i});var c=r(96540);const s={},l=c.createContext(s);function a(e){const n=c.useContext(l);return c.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),c.createElement(l.Provider,{value:n},e.children)}}}]);