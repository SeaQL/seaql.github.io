"use strict";(self.webpackChunkseaography=self.webpackChunkseaography||[]).push([[4385],{8032:(n,t,e)=>{e.d(t,{R:()=>r,x:()=>i});var o=e(2374);const s={},a=o.createContext(s);function r(n){const t=o.useContext(a);return o.useMemo((function(){return"function"==typeof n?n(t):{...t,...n}}),[t,n])}function i(n){let t;return t=n.disableParentContext?"function"==typeof n.components?n.components(s):n.components||s:r(n.components),o.createElement(a.Provider,{value:t},n.children)}},9210:(n,t,e)=>{e.r(t),e.d(t,{assets:()=>u,contentTitle:()=>i,default:()=>d,frontMatter:()=>r,metadata:()=>o,toc:()=>l});const o=JSON.parse('{"id":"custom-endpoints/custom-mutation","title":"Custom Mutation","description":"Simple operations","source":"@site/docs/04-custom-endpoints/03-custom-mutation.md","sourceDirName":"04-custom-endpoints","slug":"/custom-endpoints/custom-mutation","permalink":"/Seaography/docs/custom-endpoints/custom-mutation","draft":false,"unlisted":false,"editUrl":"https://github.com/SeaQL/seaql.github.io/edit/master/Seaography/docs/04-custom-endpoints/03-custom-mutation.md","tags":[],"version":"current","lastUpdatedBy":"Chris Tsang","lastUpdatedAt":1761251444000,"sidebarPosition":3,"frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Custom Query","permalink":"/Seaography/docs/custom-endpoints/custom-query"},"next":{"title":"Custom Union","permalink":"/Seaography/docs/custom-endpoints/custom-union"}}');var s=e(8790),a=e(8032);const r={},i="Custom Mutation",u={},l=[{value:"Simple operations",id:"simple-operations",level:2},{value:"Handling Uploads",id:"handling-uploads",level:2},{value:"Custom Mutation with Custom Input",id:"custom-mutation-with-custom-input",level:2}];function c(n){const t={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",p:"p",pre:"pre",...(0,a.R)(),...n.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(t.header,{children:(0,s.jsx)(t.h1,{id:"custom-mutation",children:"Custom Mutation"})}),"\n",(0,s.jsx)(t.h2,{id:"simple-operations",children:"Simple operations"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-rust",children:'#[CustomFields]\nimpl Operations {\n    async fn hello(_ctx: &Context<\'_>, name: String) -> async_graphql::Result<String> {\n        Ok(format!("Hello, {}!", name))\n    }\n\n    async fn sum(_ctx: &Context<\'_>, x: i32, y: i32) -> async_graphql::Result<i32> {\n        Ok(x + y)\n    }\n\n    async fn verify(ctx: &Context<\'_>, token: String) -> async_graphql::Result<profile::Model> {\n        let db = ctx.data::<DatabaseConnection>()?;\n        let session = ctx.data::<Session>()?;\n        verify_user_token(session.user_id, &token)?;\n        // verification succeeds, return user profile\n        Ok(profile::Entity::find_by_user_id(session.user_id)\n            .one(db)\n            .await?\n            .ok_or_else(|| DbErr::RecordNotFound("Profile not found".into()))?)\n    }\n}\n'})}),"\n",(0,s.jsx)(t.h2,{id:"handling-uploads",children:"Handling Uploads"}),"\n",(0,s.jsxs)(t.p,{children:["Refer to ",(0,s.jsx)(t.code,{children:"async-graphql"})," ",(0,s.jsx)(t.a,{href:"https://docs.rs/async-graphql/latest/async_graphql/types/struct.Upload.html",children:"documentation"})," for more info."]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-rust",children:'use async_graphql::Upload;\n\n#[CustomFields]\nimpl Operations {\n    async fn upload(ctx: &Context<\'_>, upload: Upload) -> async_graphql::Result<String> {\n        Ok(format!(\n            "uploaded: filename={}",\n            upload.value(ctx).unwrap().filename\n        ))\n    }\n}\n'})}),"\n",(0,s.jsx)(t.h2,{id:"custom-mutation-with-custom-input",children:"Custom Mutation with Custom Input"}),"\n",(0,s.jsx)(t.p,{children:"Say we want to create a transactional endpoint for staff members in store to handle customer rentals."}),"\n",(0,s.jsx)(t.p,{children:"First we can design the data structures for the input form:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-rust",children:"use sea_orm::entity::prelude::{DateTimeUtc};\nuse seaography::{async_graphql, CustomFields, CustomInputType};\n\n#[derive(Clone, CustomInputType)]\npub struct RentalRequest {\n    pub customer: String,\n    pub film: String,\n    pub coupon: Option<Coupon>, // \u2b05 nested objects are supported\n    pub timestamp: DateTimeUtc,\n}\n\n#[derive(Clone, CustomInputType)]\npub struct Coupon {\n    pub code: String,\n    pub points: Option<Decimal>,\n}\n"})}),"\n",(0,s.jsx)(t.p,{children:"Then we can define the mutation endpoint:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-rust",children:"#[CustomFields]\nimpl Operations {\n    async fn rental_request(\n        ctx: &Context<'_>,\n        rental_request: RentalRequest,\n        //              \u2b06 our custom input struct\n    ) -> async_graphql::Result<rental::Model> {\n        //                     \u2b06 a normal SeaORM Model\n        let db = ctx.data::<DatabaseConnection>()?;\n        let session = ctx.data::<Session>()?;\n        let txn = db.begin().await?;\n        //  \u2b06 create a transaction to make operation atomic\n\n        let customer = Customer::find_by_name(rental_request.customer, &txn).await?;\n        let film = Film::find_by_name(rental_request.film, &txn).await?;\n        //  \u2b06 helper methods to find the corresponding customer and film\n\n        //  \u2b07 find if there is inventory in current store\n        let inventory = Inventory::find()\n            .filter(inventory::Column::FilmId.eq(film.id))\n            .filter(inventory::Column::StoreId.eq(session.store_id))\n            .one(&txn)\n            .unwrap_or(Error::NoInventory)?;\n        //  \u2b06 return error if no inventory\n\n        let rental = rental::ActiveModel {\n            rental_date: Set(rental_request.timestamp),\n            inventory_id: Set(inventory.id),\n            customer_id: Set(customer.id),\n            staff_id: Set(session.staff_id), // \u2b05 current staff\n            last_update: Set(Utc::now()),\n            ..Default::default()\n        }.insert(&txn).await?;\n\n        inventory.delete(&txn).await?;\n        //       \u2b06 now remove it from inventory\n        txn.commit().await?;\n        // \u2b07 return the newly created rental record\n        Ok(rental)\n    }\n}\n"})})]})}function d(n={}){const{wrapper:t}={...(0,a.R)(),...n.components};return t?(0,s.jsx)(t,{...n,children:(0,s.jsx)(c,{...n})}):c(n)}}}]);